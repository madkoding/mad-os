#!/bin/bash
export XDG_SESSION_TYPE=wayland
export XDG_CURRENT_DESKTOP=sway
export MOZ_ENABLE_WAYLAND=1

# Use systemd-logind as the seat management backend (madOS uses systemd)
export LIBSEAT_BACKEND=logind

if [ -x /usr/local/bin/detect-legacy-hardware ]; then
    if /usr/local/bin/detect-legacy-hardware >/dev/null 2>&1; then
        export WLR_RENDERER=pixman
        export WLR_NO_HARDWARE_CURSORS=1
        export LIBGL_ALWAYS_SOFTWARE=1
        export MESA_GL_VERSION_OVERRIDE=3.3
        # GTK: disable Vulkan renderer to avoid GPU probe errors
        export GSK_RENDERER=cairo
        # Chromium: force software rendering on legacy hardware
        export CHROMIUM_FLAGS="${CHROMIUM_FLAGS:-} --disable-gpu"
        logger -p user.info -t mados-sway "Starting sway with software rendering (pixman)"
    fi
else
    if systemd-detect-virt --vm --quiet 2>/dev/null; then
        export WLR_RENDERER=pixman
        export WLR_NO_HARDWARE_CURSORS=1
        export LIBGL_ALWAYS_SOFTWARE=1
        export MESA_GL_VERSION_OVERRIDE=3.3
        # GTK: disable Vulkan renderer to avoid GPU probe errors
        export GSK_RENDERER=cairo
        # Chromium: force software rendering in VMs without 3D
        export CHROMIUM_FLAGS="${CHROMIUM_FLAGS:-} --disable-gpu"
        logger -p user.info -t mados-sway "Starting sway with software rendering (VM fallback)"
    fi
fi

# VM DRM workarounds: disable atomic modesetting and modifiers for VM GPU drivers
if systemd-detect-virt --vm --quiet 2>/dev/null; then
    export WLR_DRM_NO_ATOMIC=1
    export WLR_DRM_NO_MODIFIERS=1
    export WLR_NO_HARDWARE_CURSORS=1

    # VM performance: generate optimized sway config drop-in
    # Reduces visual overhead (no gaps) for smoother experience
    VM_CONF="/etc/sway/config.d/99-vm-performance.conf"
    if [ ! -f "$VM_CONF" ]; then
        mkdir -p /etc/sway/config.d
        cat > "$VM_CONF" << 'VMCONF'
# Auto-generated VM performance optimizations
# Reduces visual overhead for smoother mouse/input in VirtualBox/VMware/QEMU
# Note: wallpaper is managed by mados-sway-wallpapers, not here
gaps inner 0
gaps outer 0
VMCONF
        logger -p user.info -t mados-sway "Generated VM performance config: $VM_CONF"
    fi
fi

apply_software_rendering() {
    export WLR_RENDERER=pixman
    export WLR_NO_HARDWARE_CURSORS=1
    export LIBGL_ALWAYS_SOFTWARE=1
    export MESA_GL_VERSION_OVERRIDE=3.3
    export GSK_RENDERER=cairo
    export CHROMIUM_FLAGS="${CHROMIUM_FLAGS:-} --disable-gpu"
}

# Launch sway with fallback to software rendering if hardware rendering fails.
# If software rendering is already configured, exec sway directly.
if [ "${WLR_RENDERER:-}" = "pixman" ]; then
    logger -p user.info -t mados-sway "Launching sway compositor (software rendering)"
    exec sway
fi

# Try hardware rendering first; if sway exits quickly (< 5s) it likely
# failed during renderer initialisation â€” retry with pixman.
logger -p user.info -t mados-sway "Launching sway compositor"
START_TIME=$(date +%s)
sway
EXIT_CODE=$?
END_TIME=$(date +%s)
ELAPSED=$((END_TIME - START_TIME))

if [ $EXIT_CODE -ne 0 ] && [ "$ELAPSED" -lt 5 ]; then
    logger -p user.warning -t mados-sway "Sway failed in ${ELAPSED}s (exit $EXIT_CODE), retrying with software rendering"
    apply_software_rendering
    exec sway
fi
