#!/bin/bash
export XDG_SESSION_TYPE=wayland
export XDG_CURRENT_DESKTOP=sway
export MOZ_ENABLE_WAYLAND=1

# Use systemd-logind as the seat management backend (madOS uses systemd)
export LIBSEAT_BACKEND=logind

if [ -x /usr/local/bin/detect-legacy-hardware ]; then
    if /usr/local/bin/detect-legacy-hardware >/dev/null 2>&1; then
        export WLR_RENDERER=pixman
        export WLR_NO_HARDWARE_CURSORS=1
        export LIBGL_ALWAYS_SOFTWARE=1
        export MESA_GL_VERSION_OVERRIDE=3.3
        # Chromium: force software rendering on legacy hardware
        export CHROMIUM_FLAGS="${CHROMIUM_FLAGS:-} --disable-gpu"
    fi
else
    if systemd-detect-virt --vm --quiet 2>/dev/null; then
        export WLR_RENDERER=pixman
        export WLR_NO_HARDWARE_CURSORS=1
        export LIBGL_ALWAYS_SOFTWARE=1
        export MESA_GL_VERSION_OVERRIDE=3.3
        # Chromium: force software rendering in VMs without 3D
        export CHROMIUM_FLAGS="${CHROMIUM_FLAGS:-} --disable-gpu"
    fi
fi

# VM DRM workarounds: disable atomic modesetting and modifiers for VM GPU drivers
if systemd-detect-virt --vm --quiet 2>/dev/null; then
    export WLR_DRM_NO_ATOMIC=1
    export WLR_DRM_NO_MODIFIERS=1
    export WLR_NO_HARDWARE_CURSORS=1
fi

exec sway
