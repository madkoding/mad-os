#!/bin/bash
# =============================================================================
# mados-persistence - User-facing CLI for persistence management
# =============================================================================
# Usage:
#   mados-persistence status   # Show persistence status
#   mados-persistence info     # Show setup instructions
#   mados-persistence sync     # Force manual sync (rsync mode only)
# =============================================================================

STATE_FILE="/run/mados-persist.env"
PERSISTENCE_MOUNT="/mnt/mados-persist"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

read_state() {
    MADOS_PERSIST_MODE="none"
    MADOS_PERSIST_DEVICE=""
    MADOS_PERSIST_VENTOY="0"
    MADOS_PERSIST_ACTIVE="0"

    if [ -f "$STATE_FILE" ]; then
        # shellcheck source=/dev/null
        . "$STATE_FILE"
    fi
}

cmd_status() {
    read_state

    echo -e "${BLUE}=== madOS Persistence Status ===${NC}"
    echo ""

    case "$MADOS_PERSIST_MODE" in
        cow_device)
            echo -e "${GREEN}Mode: Archiso cow_device (native transparent persistence)${NC}"
            echo -e "Device: ${MADOS_PERSIST_DEVICE}"
            echo -e "All changes are saved ${GREEN}automatically${NC} to the device."
            echo "No sync needed."
            ;;
        cow_label)
            echo -e "${GREEN}Mode: Archiso cow_label (native transparent persistence)${NC}"
            echo -e "Device: ${MADOS_PERSIST_DEVICE}"
            echo -e "All changes are saved ${GREEN}automatically${NC} via overlay."
            echo "No sync needed."
            ;;
        partition)
            echo -e "${GREEN}Mode: rsync-based (partition)${NC}"
            echo -e "Device: ${MADOS_PERSIST_DEVICE}"
            if mountpoint -q "$PERSISTENCE_MOUNT" 2>/dev/null; then
                echo -e "Mount: ${GREEN}$PERSISTENCE_MOUNT (mounted)${NC}"
                local used
                used=$(df -h "$PERSISTENCE_MOUNT" 2>/dev/null | tail -1 | awk '{print $3 "/" $2 " (" $5 ")"}')
                echo -e "Usage: $used"
            else
                echo -e "Mount: ${RED}Not mounted${NC}"
            fi
            echo ""
            echo "Data is synced every 5 minutes (home, root, configs)."
            echo "Force sync: sudo mados-persistence sync"
            ;;
        file)
            echo -e "${GREEN}Mode: rsync-based (file)${NC}"
            echo -e "File: ${MADOS_PERSIST_DEVICE}"
            if mountpoint -q "$PERSISTENCE_MOUNT" 2>/dev/null; then
                echo -e "Mount: ${GREEN}$PERSISTENCE_MOUNT (mounted)${NC}"
            else
                echo -e "Mount: ${RED}Not mounted${NC}"
            fi
            echo ""
            echo "Data is synced every 5 minutes (home, root, configs)."
            echo "Force sync: sudo mados-persistence sync"
            ;;
        *)
            echo -e "${YELLOW}Persistence: INACTIVE${NC}"
            echo ""
            echo "Changes will be lost on reboot."
            echo "Run 'mados-persistence info' to see how to enable persistence."
            ;;
    esac

    echo ""
    if [ "$MADOS_PERSIST_VENTOY" = "1" ]; then
        echo -e "Boot method: ${BLUE}Ventoy${NC}"
    elif [ -d /run/archiso ]; then
        echo -e "Boot method: ${BLUE}Direct USB/ISO${NC}"
    else
        echo -e "Boot method: ${BLUE}Installed system${NC}"
    fi
}

cmd_sync() {
    read_state

    if [ "$MADOS_PERSIST_MODE" = "partition" ] || [ "$MADOS_PERSIST_MODE" = "file" ]; then
        echo "Forcing sync..."
        /usr/local/bin/mados-persist-sync.sh sync
        echo -e "${GREEN}Sync complete!${NC}"
    elif [ "$MADOS_PERSIST_MODE" = "cow_device" ] || [ "$MADOS_PERSIST_MODE" = "cow_label" ]; then
        echo -e "${GREEN}Native persistence active. Changes are saved automatically.${NC}"
    else
        echo -e "${RED}No persistence active. Nothing to sync.${NC}"
        exit 1
    fi
}

cmd_info() {
    echo -e "${BLUE}=== madOS Persistence Guide ===${NC}"
    echo ""
    echo -e "${GREEN}Option 1: USB with persistence partition (recommended)${NC}"
    echo "  1. Write the ISO to USB:"
    echo "     sudo dd if=madOS.iso of=/dev/sdX bs=4M status=progress"
    echo "  2. Create an ext4 partition on remaining USB space:"
    echo "     sudo fdisk /dev/sdX   # Add new partition"
    echo "     sudo mkfs.ext4 -L mados-persist /dev/sdX3"
    echo "  3. Boot and select 'madOS Live with Persistence'"
    echo "  4. The partition is auto-detected via cow_label=mados-persist"
    echo ""
    echo -e "${GREEN}Option 2: Ventoy USB (persistence via Ventoy)${NC}"
    echo "  1. Install Ventoy on USB: https://ventoy.net"
    echo "  2. Copy madOS.iso to USB"
    echo "  3. Create persistence image (on another PC):"
    echo "     sudo sh CreatePersistentImg.sh -s 4096 -l mados-persist"
    echo "     (Download from: https://ventoy.net/en/plugin_persistence.html)"
    echo "  4. Copy persistence.dat to /ventoy/persistence/ on the USB"
    echo "  5. Configure /ventoy/ventoy.json:"
    echo '     {'
    echo '       "persistence": [{'
    echo '         "image": "/madOS.iso",'
    echo '         "backend": "/ventoy/persistence/persistence.dat"'
    echo '       }]'
    echo '     }'
    echo "  6. Ventoy handles persistence automatically at boot"
    echo ""
    echo -e "${GREEN}Option 3: ISO without persistence${NC}"
    echo "  Boot normally. All changes stay in RAM and are lost on reboot."
    echo "  The 'madOS Live' option uses cow_spacesize=256M for temp storage."
    echo ""
    echo -e "${YELLOW}Commands:${NC}"
    echo "  mados-persistence status  # Check current persistence mode"
    echo "  mados-persistence info    # This help"
    echo "  mados-persistence sync    # Force sync (rsync mode only)"
}

case "${1:-status}" in
    status)
        cmd_status
        ;;
    sync)
        cmd_sync
        ;;
    info|--help|-h)
        cmd_info
        ;;
    *)
        echo "Unknown command: $1"
        echo "Usage: mados-persistence {status|sync|info}"
        exit 1
        ;;
esac
