#!/bin/bash

PERSISTENCE_FILE="/mados-persistence.dat"
PERSISTENCE_MOUNT="/mnt/mados-persist"
MOUNTED_PERSIST=""

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

print_status() {
    echo -e "${GREEN}mados-persistence${NC} - Ventoy-style persistent USB manager"
    echo ""
}

detect_persistence() {
    local boot_dev=""
    
    if [ -d /run/archiso/bootmnt ]; then
        boot_dev="/run/archiso/bootmnt"
    elif [ -f /proc/cmdline ]; then
        local cmdline=$(cat /proc/cmdline)
        for param in $cmdline; do
            case "$param" in
                archisosearchuuid=*)
                    local uuid="${param#*=}"
                    boot_dev=$(blkid -U "$uuid" 2>/dev/null)
                    boot_dev=$(dirname "$boot_dev")
                    break
                    ;;
            esac
        done
    fi
    
    if [ -n "$boot_dev" ]; then
        if [ -f "${boot_dev}${PERSISTENCE_FILE}" ]; then
            echo "${boot_dev}${PERSISTENCE_FILE}"
            return 0
        elif [ -f "${boot_dev}/ventoy${PERSISTENCE_FILE}" ]; then
            echo "${boot_dev}/ventoy${PERSISTENCE_FILE}"
            return 0
        fi
    fi
    
    for label in "mados-persist" "vtoycow" "persistence"; do
        local device=$(blkid -L "$label" 2>/dev/null)
        if [ -n "$device" ]; then
            echo "$device"
            return 0
        fi
    done
    
    return 1
}

check_ventoy_mode() {
    if [ -f /proc/cmdline ]; then
        local cmdline=$(cat /proc/cmdline)
        for param in $cmdline; do
            case "$param" in
                cow_device=*)
                    return 0
                    ;;
            esac
        done
    fi
    return 1
}

cmd_status() {
    echo "=== Persistence Status ==="
    echo ""
    
    if check_ventoy_mode; then
        echo -e "${GREEN}Mode: Ventoy cow_device (native persistence)${NC}"
    elif [ -n "$MADOS_PERSISTENCE_ACTIVE" ]; then
        echo -e "${GREEN}Persistence: ACTIVE (file-based)${NC}"
    else
        echo -e "${YELLOW}Persistence: INACTIVE${NC}"
    fi
    
    if [ -n "$MADOS_PERSISTENCE_DIR" ]; then
        echo "Persistence directory: $MADOS_PERSISTENCE_DIR"
    fi
    
    if [ -n "$MADOS_PERSISTENCE_DEVICE" ]; then
        echo "Persistence device: $MADOS_PERSISTENCE_DEVICE"
    fi
    
    echo ""
    echo "=== Looking for persistence file on boot device ==="
    
    if detect_persistence; then
        echo -e "${GREEN}Found persistence file/partition${NC}"
    else
        echo -e "${RED}No persistence file found${NC}"
    fi
    
    echo ""
    echo "=== Boot parameters ==="
    if [ -f /proc/cmdline ]; then
        grep -oE 'cow_spacesize=[^ ]+' /proc/cmdline 2>/dev/null || echo "No cow_spacesize parameter"
        grep -oE 'cow_device=[^ ]+' /proc/cmdline 2>/dev/null || echo "No cow_device parameter (Ventoy sets this automatically)"
    fi
}

cmd_enable() {
    echo "=== Enabling Persistence ==="
    
    if check_ventoy_mode; then
        echo -e "${GREEN}Already in Ventoy cow_device mode!${NC}"
        echo "Your changes are being saved automatically to the .dat file"
        exit 0
    fi
    
    local persist_file=$(detect_persistence)
    
    if [ -z "$persist_file" ]; then
        echo -e "${RED}No persistence file found!${NC}"
        echo ""
        echo "To create a persistence file:"
        echo "  1. Run: sudo mados-persistence-img.sh -s 4096"
        echo "  2. Copy the file to your USB as 'mados-persistence.dat'"
        echo "  3. Or create a partition with label 'mados-persist'"
        exit 1
    fi
    
    echo "Persistence file: $persist_file"
    
    if [[ "$persist_file" == /dev/* ]]; then
        echo "Using block device directly"
        export MADOS_PERSISTENCE_DIR="$persist_file"
    else
        mkdir -p "$PERSISTENCE_MOUNT"
        
        if [[ "$persist_file" == *.dat ]]; then
            local loop_dev=$(losetup -f --show "$persist_file" 2>/dev/null)
            if [ -z "$loop_dev" ]; then
                echo -e "${RED}Failed to create loop device${NC}"
                exit 1
            fi
            mount -o rw "$loop_dev" "$PERSISTENCE_MOUNT"
        else
            mount -o rw "$persist_file" "$PERSISTENCE_MOUNT"
        fi
        
        export MADOS_PERSISTENCE_DIR="$PERSISTENCE_MOUNT"
    fi
    
    export MADOS_PERSISTENCE_ACTIVE=1
    
    echo -e "${GREEN}Persistence enabled!${NC}"
    echo "Changes will now be saved to: $MADOS_PERSISTENCE_DIR"
    echo ""
    echo "Note: For permanent persistence, you need to:"
    echo "  1. Boot with 'madOS Live with Persistence' option"
    echo "  2. Or configure cow_device parameter in boot loader"
}

cmd_disable() {
    echo "=== Disabling Persistence ==="
    
    if [ -d "$PERSISTENCE_MOUNT" ]; then
        umount "$PERSISTENCE_MOUNT" 2>/dev/null || true
    fi
    
    for loop_dev in $(losetup -j /mados-persistence.dat 2>/dev/null | cut -d: -f1); do
        losetup -d "$loop_dev" 2>/dev/null || true
    done
    
    unset MADOS_PERSISTENCE_ACTIVE
    unset MADOS_PERSISTENCE_DIR
    
    echo -e "${GREEN}Persistence disabled${NC}"
}

cmd_info() {
    print_status
    
    echo -e "${BLUE}=== MODOS DE PERSISTENCIA ===${NC}"
    echo ""
    echo -e "${GREEN}Opción 1: ISO simple (sin persistencia)${NC}"
    echo "  dd if=mados.iso of=/dev/sdb"
    echo "  Listo. Boot normal."
    echo ""
    echo -e "${GREEN}Opción 2: Ventoy (CON persistencia)${NC}"
    echo "  1. Install Ventoy en USB"
    echo "  2. Descargar script CreatePersistentImg.sh de ventoy.net"
    echo "  3. sudo sh CreatePersistentImg.sh -s 4096 -l mados-persist"
    echo "  4. Copiar mados-persistence.dat al USB (/ventoy/persistence/)"
    echo "  5. Configurar ventoy.json"
    echo ""
    echo "Mas info: https://www.ventoy.net/en/plugin_persistence.html"
    echo ""
    echo "Comandos:"
    echo "  mados-persistence status    # Ver estado"
    echo "  mados-persistence info     # Esta ayuda"
}

case "${1:-status}" in
    status)
        cmd_status
        ;;
    enable)
        cmd_enable
        ;;
    disable)
        cmd_disable
        ;;
    info|--help|-h)
        cmd_info
        ;;
    *)
        echo "Unknown command: $1"
        echo "Use: status, enable, disable, or info"
        exit 1
        ;;
esac
