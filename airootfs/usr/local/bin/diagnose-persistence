#!/usr/bin/env bash
# madOS Persistence Diagnostic Tool
# Helps diagnose why partition creation failed

set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}╔════════════════════════════════════════════════════════╗${NC}"
echo -e "${BLUE}║     madOS Persistence Diagnostic Tool                 ║${NC}"
echo -e "${BLUE}╚════════════════════════════════════════════════════════╝${NC}"
echo

# Function to find ISO device
find_iso_device() {
    local iso_device=""
    
    if [ -d /run/archiso/bootmnt ]; then
        local raw_source
        raw_source=$(findmnt -n -o SOURCE /run/archiso/bootmnt 2>/dev/null \
                     | sed 's/\[.*\]//')
        if [ -n "$raw_source" ] && [ -b "$raw_source" ]; then
            if [[ "$raw_source" == /dev/loop* ]]; then
                local backing
                backing=$(losetup -nO BACK-FILE "$raw_source" 2>/dev/null | head -1)
                if [ -n "$backing" ]; then
                    local back_dev
                    back_dev=$(df --output=source "$backing" 2>/dev/null | tail -1)
                    [ -n "$back_dev" ] && [ -b "$back_dev" ] && raw_source="$back_dev"
                fi
            fi
            if [[ "$raw_source" == *"nvme"*p[0-9]* || "$raw_source" == *"mmcblk"*p[0-9]* ]]; then
                iso_device=$(echo "$raw_source" | sed 's/p[0-9]*$//')
            else
                iso_device=$(echo "$raw_source" | sed 's/[0-9]*$//')
            fi
        fi
    fi
    
    if [ -z "$iso_device" ]; then
        iso_device=$(lsblk -nlo NAME,LABEL 2>/dev/null \
                     | grep -iE "(ARCHISO|MADOS)" | head -1 \
                     | awk '{print $1}')
        if [ -n "$iso_device" ]; then
            if [[ "$iso_device" == *"nvme"*p[0-9]* || "$iso_device" == *"mmcblk"*p[0-9]* ]]; then
                iso_device=$(echo "/dev/$iso_device" | sed 's/p[0-9]*$//')
            else
                iso_device=$(echo "/dev/$iso_device" | sed 's/[0-9]*$//')
            fi
        fi
    fi
    echo "$iso_device"
}

# 1. Identify ISO device
echo -e "${YELLOW}[1] Detecting ISO/USB device...${NC}"
ISO_DEVICE=$(find_iso_device)
if [ -z "$ISO_DEVICE" ]; then
    echo -e "${RED}✗ Cannot detect ISO device${NC}"
    exit 1
fi
echo -e "${GREEN}✓ ISO Device: $ISO_DEVICE${NC}"
echo

# 2. Show device info
echo -e "${YELLOW}[2] Device Information:${NC}"
lsblk -o NAME,SIZE,TYPE,FSTYPE,LABEL,MOUNTPOINT "$ISO_DEVICE" 2>/dev/null || echo "lsblk failed"
echo

# 3. Check if device is writable
echo -e "${YELLOW}[3] Device access check:${NC}"
if [ -w "$ISO_DEVICE" ]; then
    echo -e "${GREEN}✓ Device is writable${NC}"
else
    echo -e "${RED}✗ Device is NOT writable (permission denied)${NC}"
    echo "  Try running with sudo"
fi
echo

# 4. Show partition table
echo -e "${YELLOW}[4] Current partition table:${NC}"
parted -s "$ISO_DEVICE" unit MB print 2>&1 || echo "parted failed"
echo

# 5. Show partition table type
echo -e "${YELLOW}[5] Partition table type:${NC}"
TABLE_TYPE=$(parted -s "$ISO_DEVICE" print 2>/dev/null | grep -i "^Partition Table:" | awk '{print $3}')
echo "Type: $TABLE_TYPE"
if [ "$TABLE_TYPE" = "msdos" ]; then
    PART_COUNT=$(parted -s "$ISO_DEVICE" print 2>/dev/null | grep -c "^ [0-9]")
    echo "Current partitions: $PART_COUNT / 4 (MBR limit)"
    if [ "$PART_COUNT" -ge 4 ]; then
        echo -e "${RED}✗ MBR partition table is FULL (4/4 partitions)${NC}"
        echo "  Solution: Convert to GPT or use existing partition"
    fi
fi
echo

# 6. Check free space
echo -e "${YELLOW}[6] Free space analysis:${NC}"
parted -s "$ISO_DEVICE" unit MB print free 2>&1 | grep -i "free space" || echo "No free space detected by parted"
FREE_SPACE=$(parted -s "$ISO_DEVICE" unit MB print free 2>/dev/null \
             | grep "Free Space" | tail -1 | awk '{print $3}' | sed 's/MB//')
FREE_SPACE="${FREE_SPACE%%.*}"

# Fallback: calculate from disk size minus last partition end
if [ -z "$FREE_SPACE" ] || [ "${FREE_SPACE:-0}" -eq 0 ]; then
    DISK_MB=$(( $(blockdev --getsize64 "$ISO_DEVICE" 2>/dev/null || echo 0) / 1048576 ))
    LAST_END=$(parted -s "$ISO_DEVICE" unit MB print 2>/dev/null \
               | grep "^ [0-9]" | awk '{gsub(/MB/,""); print $3}' | sort -n | tail -1)
    LAST_END="${LAST_END%%.*}"
    if [ "${DISK_MB:-0}" -gt 0 ] && [ "${LAST_END:-0}" -gt 0 ]; then
        FREE_SPACE=$((DISK_MB - LAST_END))
        echo "  (Calculated from disk size: ${DISK_MB}MB - last partition end: ${LAST_END}MB)"
    fi
fi

if [ -n "$FREE_SPACE" ] && [ "${FREE_SPACE:-0}" -gt 0 ]; then
    echo "Available: ${FREE_SPACE}MB"
    if [ "${FREE_SPACE}" -lt 100 ]; then
        echo -e "${RED}✗ Insufficient space (<100MB required)${NC}"
    else
        echo -e "${GREEN}✓ Sufficient space available${NC}"
    fi
else
    echo -e "${YELLOW}⚠ Could not determine free space${NC}"
fi
echo

# 7. Check if device is mounted
echo -e "${YELLOW}[7] Mount status:${NC}"
if mount | grep -q "^$ISO_DEVICE"; then
    echo -e "${YELLOW}⚠ Device or partitions are mounted:${NC}"
    mount | grep "^$ISO_DEVICE"
else
    echo -e "${GREEN}✓ No partitions currently mounted${NC}"
fi
echo

# 8. Check for persistence partition
echo -e "${YELLOW}[8] Checking for existing persistence partition:${NC}"
PERSIST_PART=$(lsblk -nlo NAME,LABEL "$ISO_DEVICE" 2>/dev/null \
               | grep "persistence" | awk '{print "/dev/" $1}' | head -1)
if [ -n "$PERSIST_PART" ]; then
    echo -e "${GREEN}✓ Found: $PERSIST_PART${NC}"
    lsblk -o NAME,SIZE,FSTYPE,LABEL,MOUNTPOINT "$PERSIST_PART"
else
    echo -e "${YELLOW}⚠ No persistence partition found${NC}"
fi
echo

# 9. Check system logs
echo -e "${YELLOW}[9] Recent persistence log (last 20 lines):${NC}"
if [ -f /var/log/mados-persistence.log ]; then
    tail -n 20 /var/log/mados-persistence.log
else
    echo "No log file found at /var/log/mados-persistence.log"
fi
echo

# 10. Check kernel messages for device errors
echo -e "${YELLOW}[10] Recent kernel messages about $ISO_DEVICE:${NC}"
dmesg | grep "${ISO_DEVICE#/dev/}" | tail -n 10 || echo "No kernel messages"
echo

# 11. Manual partition creation test
echo -e "${YELLOW}[11] Testing manual partition creation (DRY RUN):${NC}"
echo "This will show what would happen without actually creating the partition"
echo
LAST_PART_NUM=$(parted -s "$ISO_DEVICE" print 2>/dev/null \
                | grep "^ [0-9]" | tail -1 | awk '{print $1}')
LAST_PART_END=$(parted -s "$ISO_DEVICE" unit MB print 2>/dev/null \
                | grep "^ ${LAST_PART_NUM}" | awk '{print $3}' | sed 's/MB//')

echo "Last partition: $LAST_PART_NUM"
echo "Last partition ends at: ${LAST_PART_END}MB"
echo "New partition would be: $((LAST_PART_NUM + 1))"
echo "Starting at: ${LAST_PART_END}MB"
echo
echo "Commands that would be tried:"
if command -v sfdisk >/dev/null 2>&1; then
    # Show sfdisk-based approach (preferred for isohybrid ISOs)
    USED_END=$(sfdisk -d "$ISO_DEVICE" 2>/dev/null | grep "^/" | while read -r line; do
        S=$(echo "$line" | sed -n 's/.*start=\s*\([0-9]*\).*/\1/p')
        Z=$(echo "$line" | sed -n 's/.*size=\s*\([0-9]*\).*/\1/p')
        [ -n "$S" ] && [ -n "$Z" ] && echo $((S + Z))
    done | sort -n | tail -1)
    if [ -n "$USED_END" ]; then
        NEW_START=$(( ((USED_END + 2047) / 2048) * 2048 ))
        echo "  1. sfdisk (preferred): echo 'start=$NEW_START, type=linux' | sfdisk --append $ISO_DEVICE"
    fi
fi
echo "  2. parted (fallback):  parted -s $ISO_DEVICE mkpart primary ext4 ${LAST_PART_END}MB 100%"
echo

# 12. Check for existing ext4 partitions
echo -e "${YELLOW}[12] Scanning for existing ext4 partitions:${NC}"
FOUND_EXT4=false
for part in $(lsblk -nlo NAME "$ISO_DEVICE" 2>/dev/null | tail -n +2); do
    FULL="/dev/$part"
    if [ -b "$FULL" ]; then
        FSTYPE=$(blkid -s TYPE -o value "$FULL" 2>/dev/null)
        LABEL=$(blkid -s LABEL -o value "$FULL" 2>/dev/null)
        if [ "$FSTYPE" = "ext4" ]; then
            echo -e "${GREEN}✓ Found ext4: $FULL (label: '${LABEL:-none}')${NC}"
            FOUND_EXT4=true
        fi
    fi
done
if [ "$FOUND_EXT4" = false ]; then
    echo -e "${YELLOW}⚠ No ext4 partitions found on $ISO_DEVICE${NC}"
fi
echo

echo -e "${BLUE}════════════════════════════════════════════════════════${NC}"
echo -e "${BLUE}Diagnostic complete!${NC}"
echo
echo -e "${YELLOW}Common issues and solutions:${NC}"
echo "1. Device not writable → Run with sudo"
echo "2. MBR table full (4/4) → Convert to GPT or use logical partitions"
echo "3. Insufficient space → Use larger USB or free up space"
echo "4. Partitions mounted → Unmount before creating partition"
echo "5. Device busy → Check if other processes are using it"
