#!/bin/bash
# madOS Debug Helper - Quick access to logs and system diagnostics
# Usage: mados-debug [category]
# Categories: sway, journal, apps, chromium, network, audio, boot, installer, all

set -euo pipefail

GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

header() {
    echo -e "\n${BLUE}══════════════════════════════════════════════${NC}"
    echo -e "${GREEN}  $1${NC}"
    echo -e "${BLUE}══════════════════════════════════════════════${NC}\n"
}

show_help() {
    cat << 'EOF'
madOS Debug Helper - Quick access to logs and system diagnostics

Usage: mados-debug [category]

Categories:
  sway        Sway compositor logs and window info
  journal     Full systemd journal (current boot)
  apps        Python application logs (photo viewer, PDF, wifi, equalizer)
  chromium    Chromium browser diagnostics
  network     NetworkManager / iwd / WiFi logs
  audio       PipeWire / audio system logs
  boot        Boot analysis and failed services
  installer   madOS installer logs
  all         Show summary of all categories

Without arguments, shows a system overview with key diagnostics.

Log Locations Quick Reference:
  System journal:     journalctl -b
  Sway:               journalctl -b | grep -i sway
  Audio:              journalctl --user -u pipewire -b
  Network:            journalctl -u NetworkManager -b
  Installer:          /tmp/mados-install.log
  Persistence:        /var/log/mados-persistence.log
  Chromium flags:     /etc/chromium-flags.conf

Full documentation: /usr/share/doc/madOS/DEBUGGING.md
EOF
}

debug_sway() {
    header "Sway Compositor Logs"
    echo -e "${YELLOW}Recent Sway-related journal entries:${NC}"
    journalctl -b --no-pager -n 30 | grep -i sway || echo "(no sway entries found)"
    echo ""
    if command -v swaymsg &>/dev/null && [ -n "${SWAYSOCK:-}" ]; then
        echo -e "${YELLOW}Current outputs:${NC}"
        swaymsg -t get_outputs 2>/dev/null | jq -r '.[] | "\(.name): \(.current_mode.width)x\(.current_mode.height)"' 2>/dev/null || echo "(sway not running or jq unavailable)"
        echo ""
        echo -e "${YELLOW}Current inputs:${NC}"
        swaymsg -t get_inputs 2>/dev/null | jq -r '.[] | "\(.identifier): \(.type)"' 2>/dev/null || echo "(sway not running or jq unavailable)"
    else
        echo -e "${YELLOW}Sway is not running or SWAYSOCK not set${NC}"
    fi
}

debug_journal() {
    header "System Journal (last 50 lines)"
    journalctl -b --no-pager -n 50
}

debug_apps() {
    header "Python Applications Diagnostics"
    echo -e "${YELLOW}PYTHONPATH:${NC} ${PYTHONPATH:-not set}"
    echo ""

    echo -e "${YELLOW}Checking module availability:${NC}"
    for mod in mados_photo_viewer mados_pdf_viewer mados_equalizer; do
        if PYTHONPATH="/usr/local/lib:${PYTHONPATH:-}" python3 -c "import $mod" 2>/dev/null; then
            echo -e "  ${GREEN}✓${NC} $mod"
        else
            echo -e "  ${RED}✗${NC} $mod"
        fi
    done
    echo ""

    echo -e "${YELLOW}GTK3/GObject availability:${NC}"
    if python3 -c "import gi; gi.require_version('Gtk', '3.0'); from gi.repository import Gtk" 2>/dev/null; then
        echo -e "  ${GREEN}✓${NC} GTK3 is available"
    else
        echo -e "  ${RED}✗${NC} GTK3 is NOT available"
    fi
    echo ""

    echo -e "${YELLOW}Launcher scripts:${NC}"
    for script in mados-photo-viewer mados-pdf-viewer mados-equalizer; do
        if [ -x "/usr/local/bin/$script" ]; then
            if grep -q "PYTHONPATH" "/usr/local/bin/$script"; then
                echo -e "  ${GREEN}✓${NC} $script (PYTHONPATH configured)"
            else
                echo -e "  ${RED}✗${NC} $script (PYTHONPATH missing!)"
            fi
        else
            echo -e "  ${RED}✗${NC} $script not found or not executable"
        fi
    done
}

debug_chromium() {
    header "Chromium Diagnostics"
    echo -e "${YELLOW}Running as:${NC} $(whoami) (UID: $(id -u))"
    echo ""

    if [ -f /etc/chromium-flags.conf ]; then
        echo -e "${YELLOW}Chromium flags (/etc/chromium-flags.conf):${NC}"
        cat /etc/chromium-flags.conf
    else
        echo -e "${YELLOW}INFO: /etc/chromium-flags.conf not found (using defaults)${NC}"
    fi
    if [ "$(id -u)" -eq 0 ]; then
        echo -e "${RED}WARNING: Running Chromium as root is not recommended.${NC}"
        echo -e "${RED}The live session should run as the 'mados' user.${NC}"
    fi
    echo ""

    echo -e "${YELLOW}Recent Chromium-related journal entries:${NC}"
    journalctl -b --no-pager -n 20 | grep -i chrom || echo "(no chromium entries found)"
}

debug_network() {
    header "Network Diagnostics"
    echo -e "${YELLOW}Network interfaces:${NC}"
    ip -brief link show 2>/dev/null || ip link show
    echo ""

    echo -e "${YELLOW}IP addresses:${NC}"
    ip -brief addr show 2>/dev/null || ip addr show
    echo ""

    echo -e "${YELLOW}NetworkManager status:${NC}"
    systemctl is-active NetworkManager 2>/dev/null || echo "inactive"
    echo ""

    echo -e "${YELLOW}IWD status:${NC}"
    systemctl is-active iwd 2>/dev/null || echo "inactive"
    echo ""

    echo -e "${YELLOW}Recent network log entries:${NC}"
    journalctl -u NetworkManager -b --no-pager -n 15 2>/dev/null || echo "(no NetworkManager entries)"
}

debug_audio() {
    header "Audio Diagnostics"
    echo -e "${YELLOW}PipeWire status:${NC}"
    systemctl --user is-active pipewire 2>/dev/null || echo "inactive"

    echo -e "${YELLOW}WirePlumber status:${NC}"
    systemctl --user is-active wireplumber 2>/dev/null || echo "inactive"
    echo ""

    if command -v wpctl &>/dev/null; then
        echo -e "${YELLOW}WPctl status:${NC}"
        wpctl status 2>/dev/null || echo "(wpctl unavailable)"
    fi
    echo ""

    echo -e "${YELLOW}Recent audio log entries:${NC}"
    journalctl --user -u pipewire -b --no-pager -n 10 2>/dev/null || echo "(no pipewire entries)"
}

debug_boot() {
    header "Boot Diagnostics"
    echo -e "${YELLOW}Boot time:${NC}"
    systemd-analyze 2>/dev/null || echo "(unavailable)"
    echo ""

    echo -e "${YELLOW}Slowest services:${NC}"
    systemd-analyze blame --no-pager 2>/dev/null | head -10 || echo "(unavailable)"
    echo ""

    echo -e "${YELLOW}Failed services:${NC}"
    systemctl --failed --no-pager 2>/dev/null || echo "(none)"
}

debug_installer() {
    header "Installer Diagnostics"
    if [ -f /tmp/mados-install.log ]; then
        echo -e "${YELLOW}Installer log (last 30 lines):${NC}"
        tail -n 30 /tmp/mados-install.log
    else
        echo "(no installer log found at /tmp/mados-install.log)"
    fi
    echo ""

    if [ -f /var/log/mados-persistence.log ]; then
        echo -e "${YELLOW}Persistence log:${NC}"
        cat /var/log/mados-persistence.log
    else
        echo "(no persistence log found)"
    fi
}

debug_overview() {
    header "madOS System Overview"
    echo -e "${YELLOW}System:${NC}"
    echo "  Hostname:  $(hostname 2>/dev/null || echo unknown)"
    echo "  Kernel:    $(uname -r 2>/dev/null || echo unknown)"
    echo "  User:      $(whoami) (UID: $(id -u))"
    echo "  Live env:  $([ -d /run/archiso ] && echo 'Yes' || echo 'No')"
    echo ""

    echo -e "${YELLOW}Memory:${NC}"
    free -h 2>/dev/null | head -2 || echo "(unavailable)"
    echo ""

    echo -e "${YELLOW}ZRAM:${NC}"
    swapon --show 2>/dev/null || echo "(no swap)"
    echo ""

    echo -e "${YELLOW}GPU:${NC}"
    lspci 2>/dev/null | grep -i 'vga\|3d\|display' || echo "(unavailable)"
    echo ""

    echo -e "${YELLOW}Failed services:${NC}"
    systemctl --failed --no-pager --no-legend 2>/dev/null || echo "(none)"
    echo ""

    echo -e "${YELLOW}Tip:${NC} Run 'mados-debug <category>' for detailed logs."
    echo "  Categories: sway, journal, apps, chromium, network, audio, boot, installer"
    echo "  Full docs:  less /usr/share/doc/madOS/DEBUGGING.md"
}

# Main
case "${1:-}" in
    sway)      debug_sway ;;
    journal)   debug_journal ;;
    apps)      debug_apps ;;
    chromium)  debug_chromium ;;
    network)   debug_network ;;
    audio)     debug_audio ;;
    boot)      debug_boot ;;
    installer) debug_installer ;;
    all)
        debug_overview
        debug_boot
        debug_sway
        debug_chromium
        debug_apps
        debug_network
        debug_audio
        debug_installer
        ;;
    -h|--help|help) show_help ;;
    *)         debug_overview ;;
esac
