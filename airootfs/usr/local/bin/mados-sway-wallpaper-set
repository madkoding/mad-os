#!/usr/bin/env bash
# mados-sway-wallpaper-set - Set wallpaper for the current (or specified) workspace
#
# Usage: mados-sway-wallpaper-set [WORKSPACE_NUMBER]
#
# Reads wallpaper assignments from the SQLite database managed by
# mados-sway-wallpapers (~/.local/share/mados/wallpapers.db) and applies
# the correct wallpaper via swaymsg.
#
# Called from Sway key bindings as a reliable fallback in addition
# to the event subscription daemon.
#
# If no workspace number is provided, it queries sway for the current
# focused workspace.

DB_PATH="${HOME}/.local/share/mados/wallpapers.db"

ws="${1:-}"

# If no workspace number given, add a brief delay to allow Sway to finish
# switching (needed when called from workspace prev/next bindings where
# the exec runs concurrently with the workspace switch).
if [[ -z "$ws" ]]; then
    sleep 0.05
    ws="$(swaymsg -t get_workspaces 2>/dev/null \
        | jq -r '.[] | select(.focused==true) | .num' 2>/dev/null)" || true
fi

[[ -z "$ws" || "$ws" == "null" ]] && exit 0

# Read wallpaper path from SQLite database
if [[ -f "$DB_PATH" ]] && command -v sqlite3 >/dev/null 2>&1; then
    wallpaper="$(sqlite3 "$DB_PATH" \
        "SELECT w.path FROM assignments a JOIN wallpapers w ON a.wallpaper_id=w.id WHERE a.workspace=$ws LIMIT 1;" 2>/dev/null)"
    if [[ -n "$wallpaper" && -f "$wallpaper" ]]; then
        # Use swww for smooth fade transition (no black flash)
        if command -v swww >/dev/null 2>&1 && swww query >/dev/null 2>&1; then
            swww img "$wallpaper" \
                --transition-type fade \
                --transition-duration 0.5 \
                --transition-fps 60 2>/dev/null || true
        else
            # Fallback to swaymsg if swww is not available
            swaymsg output "*" bg "$wallpaper" fill 2>/dev/null || true
        fi
    fi
fi
