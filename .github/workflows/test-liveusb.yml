name: Test Live USB Persistence

on:
  push:
    paths:
      - 'airootfs/usr/local/bin/setup-persistence.sh'
      - 'airootfs/usr/local/bin/mados-persistence'
      - 'airootfs/etc/systemd/system/mados-persistence.service'
      - 'tests/test-liveusb-persistence.sh'
      - '.github/workflows/test-liveusb.yml'
  pull_request:
    paths:
      - 'airootfs/usr/local/bin/setup-persistence.sh'
      - 'airootfs/usr/local/bin/mados-persistence'
      - 'airootfs/etc/systemd/system/mados-persistence.service'
      - 'tests/test-liveusb-persistence.sh'
      - '.github/workflows/test-liveusb.yml'
  workflow_dispatch:

jobs:
  test-persistence:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Test Live USB persistence in Arch container
      run: |
        docker run --privileged --rm \
          --dns 8.8.8.8 --dns 8.8.4.4 \
          -v ${{ github.workspace }}:/build \
          archlinux:latest bash /build/tests/test-liveusb-persistence.sh
