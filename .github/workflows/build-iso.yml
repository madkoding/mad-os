name: Build madOS ISO

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Build ISO in Arch container
      run: |
        docker run --privileged --rm \
          -v ${{ github.workspace }}:/build \
          archlinux:latest bash -c "
            pacman-key --init
            pacman -Syu --noconfirm archiso
            cd /build
            mkarchiso -v -w /tmp/work -o /build/out .
            cd /build/out
            sha256sum *.iso > SHA256SUMS
            chmod -R 777 /build/out
          "
    
    - name: Get ISO filename and date
      id: iso_info
      run: |
        ISO_FILE=$(ls out/*.iso | head -1)
        ISO_NAME=$(basename "$ISO_FILE")
        # Extract date from tag (e.g., v2026.02.07 -> 2026.02.07)
        BUILD_DATE="${GITHUB_REF_NAME#v}"
        ISO_SIZE=$(stat --format=%s "$ISO_FILE")
        ISO_SIZE_MB=$((ISO_SIZE / 1024 / 1024))
        echo "iso_file=$ISO_FILE" >> "$GITHUB_OUTPUT"
        echo "iso_name=$ISO_NAME" >> "$GITHUB_OUTPUT"
        echo "build_date=$BUILD_DATE" >> "$GITHUB_OUTPUT"
        echo "iso_size_mb=$ISO_SIZE_MB" >> "$GITHUB_OUTPUT"

    - name: Install Internet Archive CLI
      run: |
        pip install internetarchive

    - name: Upload to Internet Archive
      env:
        IAS3_ACCESS_KEY: ${{ secrets.IA_ACCESS_KEY }}
        IAS3_SECRET_KEY: ${{ secrets.IA_SECRET_KEY }}
      run: |
        ISO_FILE="${{ steps.iso_info.outputs.iso_file }}"
        ISO_NAME="${{ steps.iso_info.outputs.iso_name }}"
        BUILD_DATE="${{ steps.iso_info.outputs.build_date }}"
        
        # Crear identificador √∫nico para Internet Archive (solo min√∫sculas, n√∫meros, guiones y puntos)
        IDENTIFIER="mados-${BUILD_DATE}"
        
        # Configurar credenciales
        ia configure --username="${IAS3_ACCESS_KEY}" --password="${IAS3_SECRET_KEY}"
        
        # Subir ISO con metadatos
        ia upload "$IDENTIFIER" \
          "$ISO_FILE" \
          out/SHA256SUMS \
          --metadata="title:madOS ${BUILD_DATE}" \
          --metadata="mediatype:software" \
          --metadata="collection:opensource" \
          --metadata="description:madOS - AI-Orchestrated Arch Linux Live ISO" \
          --metadata="subject:linux;arch;live-iso;open-source" \
          --metadata="creator:madOS Project" \
          --metadata="date:${BUILD_DATE}"
        
        # Generar URL de descarga
        DOWNLOAD_URL="https://archive.org/download/${IDENTIFIER}/${ISO_NAME}"
        echo "download_url=$DOWNLOAD_URL" >> "$GITHUB_OUTPUT"
      id: upload_ia

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.ref_name }}
        name: madOS ${{ steps.iso_info.outputs.build_date }}
        body: |
          ## madOS Build ${{ steps.iso_info.outputs.build_date }}
          
          **ISO:** `${{ steps.iso_info.outputs.iso_name }}`  
          **Tama√±o:** ${{ steps.iso_info.outputs.iso_size_mb }} MB
          
          ### üì• Descarga
          
          üåê **[Descargar ISO desde Internet Archive](${{ steps.upload_ia.outputs.download_url }})**
          
          _El ISO est√° alojado en Internet Archive para mejor disponibilidad y velocidad de descarga._
          
          ### ‚úÖ Verificaci√≥n
          
          Descarga tambi√©n el archivo `SHA256SUMS` y verifica:
          ```bash
          sha256sum -c SHA256SUMS
          ```
        files: |
          out/SHA256SUMS
        make_latest: true
