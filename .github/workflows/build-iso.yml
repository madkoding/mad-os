name: Build madOS ISO

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  test-installer:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Test installation process in Arch container
      run: |
        docker run --privileged --rm \
          --dns 8.8.8.8 --dns 8.8.4.4 \
          -v ${{ github.workspace }}:/build \
          archlinux:latest bash /build/tests/test-installation.sh

  build:
    needs: test-installer
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Determine build type
      id: build_type
      run: |
        if [[ "$GITHUB_REF" == refs/tags/* ]]; then
          TAG="${GITHUB_REF_NAME}"
          if [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+-beta$ ]]; then
            echo "is_release=false" >> "$GITHUB_OUTPUT"
            echo "is_prerelease=true" >> "$GITHUB_OUTPUT"
            echo "release_type=beta" >> "$GITHUB_OUTPUT"
          elif [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+-alpha$ ]]; then
            echo "is_release=false" >> "$GITHUB_OUTPUT"
            echo "is_prerelease=true" >> "$GITHUB_OUTPUT"
            echo "release_type=alpha" >> "$GITHUB_OUTPUT"
          elif [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "is_release=true" >> "$GITHUB_OUTPUT"
            echo "is_prerelease=false" >> "$GITHUB_OUTPUT"
            echo "release_type=stable" >> "$GITHUB_OUTPUT"
          else
            echo "is_release=false" >> "$GITHUB_OUTPUT"
            echo "is_prerelease=true" >> "$GITHUB_OUTPUT"
            echo "release_type=dev" >> "$GITHUB_OUTPUT"
          fi
        else
          echo "is_release=false" >> "$GITHUB_OUTPUT"
          echo "is_prerelease=true" >> "$GITHUB_OUTPUT"
          echo "release_type=dev" >> "$GITHUB_OUTPUT"
        fi
    
    - name: Build ISO in Arch container
      run: |
        docker run --privileged --rm \
          --dns 8.8.8.8 --dns 8.8.4.4 \
          -v ${{ github.workspace }}:/build \
          archlinux:latest bash -c "
            # Ensure DNS resolution works inside chroot environments
            echo 'nameserver 8.8.8.8' > /etc/resolv.conf
            echo 'nameserver 8.8.4.4' >> /etc/resolv.conf
            pacman-key --init
            pacman -Syu --noconfirm archiso
            cd /build
            mkarchiso -v -w /tmp/work -o /build/out .
            cd /build/out
            sha256sum *.iso > SHA256SUMS
            chmod -R 777 /build/out
          "
    
    - name: Get ISO filename and date
      id: iso_info
      run: |
        ISO_FILE=$(ls out/*.iso | head -1)
        ISO_NAME=$(basename "$ISO_FILE")
        if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
          VERSION="${GITHUB_REF_NAME#v}"
        else
          VERSION="dev-$(date +%Y%m%d)"
        fi
        BUILD_DATE=$(date +%Y.%m.%d)
        ISO_SIZE=$(stat --format=%s "$ISO_FILE")
        ISO_SIZE_MB=$((ISO_SIZE / 1024 / 1024))
        SHORT_SHA=$(echo "$GITHUB_SHA" | cut -c1-7)
        echo "iso_file=$ISO_FILE" >> "$GITHUB_OUTPUT"
        echo "iso_name=$ISO_NAME" >> "$GITHUB_OUTPUT"
        echo "version=$VERSION" >> "$GITHUB_OUTPUT"
        echo "build_date=$BUILD_DATE" >> "$GITHUB_OUTPUT"
        echo "iso_size_mb=$ISO_SIZE_MB" >> "$GITHUB_OUTPUT"
        echo "short_sha=$SHORT_SHA" >> "$GITHUB_OUTPUT"

    - name: Install Internet Archive CLI
      run: |
        pip install internetarchive

    - name: Upload to Internet Archive
      env:
        IAS3_ACCESS_KEY: ${{ secrets.IA_ACCESS_KEY }}
        IAS3_SECRET_KEY: ${{ secrets.IA_SECRET_KEY }}
      run: |
        ISO_FILE="${{ steps.iso_info.outputs.iso_file }}"
        ISO_NAME="${{ steps.iso_info.outputs.iso_name }}"
        VERSION="${{ steps.iso_info.outputs.version }}"
        BUILD_DATE="${{ steps.iso_info.outputs.build_date }}"
        RELEASE_TYPE="${{ steps.build_type.outputs.release_type }}"
        
        # Configure IA credentials via config file (env vars alone are unreliable)
        mkdir -p ~/.config/internetarchive
        cat > ~/.config/internetarchive/ia.ini <<EOF
        [s3]
        access = ${IAS3_ACCESS_KEY}
        secret = ${IAS3_SECRET_KEY}
        EOF
        chmod 600 ~/.config/internetarchive/ia.ini
        
        # Create unique identifier and title for Internet Archive
        if [[ "$RELEASE_TYPE" == "stable" ]]; then
          IDENTIFIER="mados-${VERSION}"
          TITLE="madOS ${VERSION}"
        else
          SHORT_SHA="${{ steps.iso_info.outputs.short_sha }}"
          IDENTIFIER="mados-${RELEASE_TYPE}-${VERSION}-${SHORT_SHA}"
          TYPE_LABEL=$(echo "${RELEASE_TYPE}" | sed 's/./\U&/')
          TITLE="madOS ${TYPE_LABEL} ${VERSION}"
        fi
        
        ia upload "$IDENTIFIER" \
          "$ISO_FILE" \
          out/SHA256SUMS \
          --retries 3 \
          --metadata="title:${TITLE}" \
          --metadata="mediatype:software" \
          --metadata="collection:opensource" \
          --metadata="description:madOS - AI-Orchestrated Arch Linux Live ISO" \
          --metadata="subject:linux;arch;live-iso;open-source" \
          --metadata="creator:madOS Project" \
          --metadata="date:${BUILD_DATE}"
        
        # Generate download URL
        DOWNLOAD_URL="https://archive.org/download/${IDENTIFIER}/${ISO_NAME}"
        echo "download_url=$DOWNLOAD_URL" >> "$GITHUB_OUTPUT"
        echo "identifier=$IDENTIFIER" >> "$GITHUB_OUTPUT"
      id: upload_ia

    - name: Update download link in website
      if: steps.build_type.outputs.is_release == 'true'
      run: |
        DOWNLOAD_URL="${{ steps.upload_ia.outputs.download_url }}"
        ISO_NAME="${{ steps.iso_info.outputs.iso_name }}"
        
        # Checkout main branch (workflow runs on detached HEAD from tag)
        git fetch origin main
        git checkout main
        
        # Actualizar el enlace en docs/index.html
        sed -i "s|https://archive.org/download/mados-[^/]*/madOS-[^\"]*\.iso|$DOWNLOAD_URL|g" docs/index.html
        
        # Verificar si hay cambios
        if git diff --quiet docs/index.html; then
          echo "No changes needed in website"
        else
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/index.html
          git commit -m "Update download link to $ISO_NAME [skip ci]"
          git push origin main
        fi

    - name: Create Release
      if: steps.build_type.outputs.is_release == 'true'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.ref_name }}
        name: madOS ${{ steps.iso_info.outputs.version }}
        append_body: true
        body: |
          
          ---
          
          **ISO:** `${{ steps.iso_info.outputs.iso_name }}`  
          **Tama√±o:** ${{ steps.iso_info.outputs.iso_size_mb }} MB
          
          ### üì• Descarga
          
          üåê **[Descargar ISO desde Internet Archive](${{ steps.upload_ia.outputs.download_url }})**
          
          _El ISO est√° alojado en Internet Archive para mejor disponibilidad y velocidad de descarga._
          
          ### ‚úÖ Verificaci√≥n
          
          Descarga tambi√©n el archivo `SHA256SUMS` y verifica:
          ```bash
          sha256sum -c SHA256SUMS
          ```
        files: |
          out/SHA256SUMS
        make_latest: true

    - name: Create Pre-release
      if: steps.build_type.outputs.is_prerelease == 'true'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.ref_name }}
        name: "madOS ${{ steps.iso_info.outputs.version }} (${{ steps.build_type.outputs.release_type }})"
        prerelease: true
        append_body: true
        body: |
          
          ---
          
          **Versi√≥n:** `${{ steps.iso_info.outputs.version }}`
          **Commit:** `${{ github.sha }}`
          **ISO:** `${{ steps.iso_info.outputs.iso_name }}`
          **Tama√±o:** ${{ steps.iso_info.outputs.iso_size_mb }} MB

          ### üì• Descarga

          üåê **[Descargar ISO desde Internet Archive](${{ steps.upload_ia.outputs.download_url }})**

          > ‚ö†Ô∏è Esta es una build de prueba (${{ steps.build_type.outputs.release_type }}). Para la versi√≥n estable, consulta la [√∫ltima release](https://github.com/${{ github.repository }}/releases/latest).

          ### ‚úÖ Verificaci√≥n

          ```bash
          sha256sum -c SHA256SUMS
          ```
        files: |
          out/SHA256SUMS
        make_latest: false
