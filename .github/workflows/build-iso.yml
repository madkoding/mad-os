name: Build madOS ISO

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Build ISO in Arch container
      run: |
        docker run --privileged --rm \
          -v ${{ github.workspace }}:/build \
          archlinux:latest bash -c "
            pacman-key --init
            pacman -Syu --noconfirm archiso
            cd /build
            mkarchiso -v -w /tmp/work -o /build/out .
            cd /build/out
            sha256sum *.iso > SHA256SUMS
            chmod -R 777 /build/out
          "
    
    - name: Get ISO filename and date
      id: iso_info
      run: |
        ISO_FILE=$(ls out/*.iso | head -1)
        ISO_NAME=$(basename "$ISO_FILE")
        # Extract date from tag (e.g., v2026.02.07 -> 2026.02.07)
        BUILD_DATE="${GITHUB_REF_NAME#v}"
        ISO_SIZE=$(stat --format=%s "$ISO_FILE")
        ISO_SIZE_MB=$((ISO_SIZE / 1024 / 1024))
        echo "iso_file=$ISO_FILE" >> "$GITHUB_OUTPUT"
        echo "iso_name=$ISO_NAME" >> "$GITHUB_OUTPUT"
        echo "build_date=$BUILD_DATE" >> "$GITHUB_OUTPUT"
        echo "iso_size_mb=$ISO_SIZE_MB" >> "$GITHUB_OUTPUT"

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.ref_name }}
        name: madOS ${{ steps.iso_info.outputs.build_date }}
        body: |
          ## madOS Build ${{ steps.iso_info.outputs.build_date }}
          
          **ISO:** `${{ steps.iso_info.outputs.iso_name }}`  
          **Tamaño:** ${{ steps.iso_info.outputs.iso_size_mb }} MB
          
          ### Verificación
          ```bash
          sha256sum -c SHA256SUMS
          ```
        files: |
          ${{ steps.iso_info.outputs.iso_file }}
          out/SHA256SUMS
        make_latest: true
