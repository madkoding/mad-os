name: "Tests: Scripts & Configuration"

on:
  push:
    paths:
      - 'airootfs/usr/local/bin/setup-*.sh'
      - 'airootfs/usr/local/bin/install-mados*'
      - 'airootfs/usr/local/bin/hyprland-session'
      - 'airootfs/etc/systemd/system/setup-*.service'
      - 'airootfs/etc/systemd/system/multi-user.target.wants/**'
      - 'airootfs/etc/sysusers.d/**'
      - 'airootfs/etc/passwd'
      - 'airootfs/etc/skel/**'
      - 'airootfs/usr/local/lib/mados_installer/**'
      - 'packages.x86_64'
      - 'profiledef.sh'
      - 'tests/test_boot_scripts.py'
      - 'tests/test_post_installation.py'
      - 'tests/test_opencode.py'
      - 'tests/test_hyprland_config.py'
      - '.github/workflows/test-scripts.yml'
  pull_request:
    paths:
      - 'airootfs/usr/local/bin/setup-*.sh'
      - 'airootfs/usr/local/bin/install-mados*'
      - 'airootfs/usr/local/bin/hyprland-session'
      - 'airootfs/etc/systemd/system/setup-*.service'
      - 'airootfs/etc/systemd/system/multi-user.target.wants/**'
      - 'airootfs/etc/sysusers.d/**'
      - 'airootfs/etc/passwd'
      - 'airootfs/etc/skel/**'
      - 'airootfs/usr/local/lib/mados_installer/**'
      - 'packages.x86_64'
      - 'profiledef.sh'
      - 'tests/test_boot_scripts.py'
      - 'tests/test_post_installation.py'
      - 'tests/test_opencode.py'
      - 'tests/test_hyprland_config.py'
      - '.github/workflows/test-scripts.yml'
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: tests-scripts-${{ github.ref }}
  cancel-in-progress: true

jobs:
  pytest:
    name: ${{ matrix.name }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Boot Scripts
            test_file: tests/test_boot_scripts.py
          - name: Post-Installation
            test_file: tests/test_post_installation.py
          - name: OpenCode
            test_file: tests/test_opencode.py
          - name: Hyprland Config
            test_file: tests/test_hyprland_config.py

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install test dependencies
        run: python3 -m pip install pytest

      - name: Run tests
        run: python3 -m pytest ${{ matrix.test_file }} -v
