FROM archlinux:latest

LABEL maintainer="madOS Team"
LABEL description="Test infrastructure for madOS persistence scripts"

# Install dependencies required for testing
RUN pacman -Sy --noconfirm \
    && pacman -S --noconfirm \
        bash \
        coreutils \
        filesystem \
        parted \
        e2fsprogs \
        dosfstools \
        util-linux \
        systemd \
        kbd \
        kmod \
        findutils \
        grep \
        sed \
        awk \
        gawk \
        diffutils \
        which \
        tree \
        iproute2 \
        net-tools \
        lsof \
        procps-ng \
        psmisc \
        python \
        python-pip \
        python-setuptools \
        python-wheel \
        python-pytest \
        python-pytest-cov \
        sudo \
        dialog \
        vim \
        git \
        make \
    && rm -rf /var/lib/pacman/sync/*

# Create build directory
RUN mkdir -p /build
WORKDIR /build

# Copy repository to build directory
COPY . /build/

# Install Python dependencies for testing
RUN pip install --break-system-packages --no-cache-dir pytest pytest-cov

# Copy entrypoint script
COPY tests/entrypoint.sh /usr/local/bin/entrypoint
RUN chmod +x /usr/local/bin/entrypoint

# Set environment variables
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV PYTHONIOENCODING=utf-8

# Default command runs tests as root
CMD ["bash", "-c", "cd /build && /usr/local/bin/entrypoint"]
